<!DOCTYPE html>
<html lang="en">
  <head>
    <title>
        Welcome to DSN - Decentralised Storage Network
    </title>
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.3.1/semantic.min.css">
    <script
      src="https://code.jquery.com/jquery-3.1.1.min.js"
      integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8="
      crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/gh/ethereum/web3.js/dist/web3.min.js"></script>
    <link href="http://getbootstrap.com/dist/css/bootstrap.min.css" rel="stylesheet">

    <script type="text/javascript">
        !function(e,i){if("function"==typeof define&&define.amd)define(["exports","jquery"],function(e,r){return i(e,r)});else if("undefined"!=typeof exports){var r=require("jquery");i(exports,r)}else i(e,e.jQuery||e.Zepto||e.ender||e.$)}(this,function(e,i){function r(e,r){function n(e,i,r){return e[i]=r,e}function a(e,i){for(var r,a=e.match(t.key);void 0!==(r=a.pop());)if(t.push.test(r)){var u=s(e.replace(/\[\]$/,""));i=n([],u,i)}else t.fixed.test(r)?i=n([],r,i):t.named.test(r)&&(i=n({},r,i));return i}function s(e){return void 0===h[e]&&(h[e]=0),h[e]++}function u(e){switch(i('[name="'+e.name+'"]',r).attr("type")){case"checkbox":return"on"===e.value?!0:e.value;default:return e.value}}function f(i){if(!t.validate.test(i.name))return this;var r=a(i.name,u(i));return l=e.extend(!0,l,r),this}function d(i){if(!e.isArray(i))throw new Error("formSerializer.addPairs expects an Array");for(var r=0,t=i.length;t>r;r++)this.addPair(i[r]);return this}function o(){return l}function c(){return JSON.stringify(o())}var l={},h={};this.addPair=f,this.addPairs=d,this.serialize=o,this.serializeJSON=c}var t={validate:/^[a-z_][a-z0-9_]*(?:\[(?:\d*|[a-z0-9_]+)\])*$/i,key:/[a-z0-9_]+|(?=\[\])/gi,push:/^$/,fixed:/^\d+$/,named:/^[a-z0-9_]+$/i};return r.patterns=t,r.serializeObject=function(){return new r(i,this).addPairs(this.serializeArray()).serialize()},r.serializeJSON=function(){return new r(i,this).addPairs(this.serializeArray()).serializeJSON()},"undefined"!=typeof i.fn&&(i.fn.serializeObject=r.serializeObject,i.fn.serializeJSON=r.serializeJSON),e.FormSerializer=r,r});
    </script>

    <style type="text/css">
      body {
        background-color: #FFFFFF;
      }
      .ui.menu .item img.logo {
        margin-right: 1.5em;
      }
      .main.container {
        margin-top: 7em;
      }
      .wireframe {
        margin-top: 2em;
      }
      .ui.footer.segment {
        margin: 5em 0em 0em;
        padding: 5em 0em;
      }
      .container {
        max-width: 1500px !important;
      }
    </style>
  </head>
  <body>
    <div class="ui fixed inverted menu">
        <div class="ui container">
          <a href="/" class="header item">
            <i class="big handshake icon"></i>Decentralized Storage Network
          </a>
        </div>
    </div>

    <div class="ui main container">
      <h1 class="ui header">Hi Client! Welcome to DSN</h1>
      <p></p>
      <p>
        Your Ethereum Address  : <span id="provider-address">{{ selfAddress }}</span>
      </p>
      <p>
        Your Ethereum Balance  : <span id="provider-balance">{{ balance }}</span>
      </p>

    <div class="ui divider"></div>

      <div class="header">
        <form class="ui form">
          <div class="field">
            <label>File Path</label>
            <div class="fields">
                <input name="path" id="pathinput" type="text" value="{{ cwd }}">
            </div>
          </div>
            <div class="ui submit button" tabindex="0" id="filepathform">Send</div>
        </form>
      </div>

    <div class="ui divider"></div>

    <h6>My Uploads</h6>
    <table class="ui celled table" id="provider-contracts">
      <thead>
        <tr>
        <th>File Name</th>
        <th>Provider</th>
        <th>Rate</th>
        <th>Service Number</th>
        <th>Download</th>
        <th>Challenge</th>
        <!-- <th>Revoke</th> -->
      </tr></thead>
      <tbody>

    {% for upload in uploads %}
        <tr>
            <td id="fp{{upload.service_num}}">{{upload.file_path}}</td>
            <td id="pa{{upload.service_num}}">{{upload.provider}}</td>
            <td id="rt{{upload.service_num}}">{{upload.rate}}</td>
            <td id="sn{{upload.service_num}}">{{upload.service_num}}</td>
            <td><a href="{{upload.provider_url}}/download/{{selfAddress}}/{{upload.service_num}}/"><i class="download icon"></i></a></td>
            <td><button class="ui button" onclick="challenge({{upload.service_num}})"><i class="fire icon"></i></button></td>
            <!-- <td><button class="ui button" onclick="revokeService({{upload.service_num}})"><i class="times icon"></i></button></td> -->
            <span id="pu{{upload.service_num}}">{{upload.provider_url}}</span>
        </tr>

    {% endfor %}
      </tbody>
    </table>

    <div class="ui divider"></div>

    <h6>List of available providers</h6>
    <table class="ui celled table" id="provider-contracts">
      <thead>
        <tr>
        <th>Provider</th>
        <th>URL</th>
        <th>Size</th>
      </tr></thead>
      <tbody>

    {% for provider in providerlist %}
        <tr>
            <td>{{provider.provider}}</td>
            <td>{{provider.providerurl}}</td>
            <td>{{provider.size}}</td>
        </tr>
    {% endfor %}
        </tbody>
    </table>

    </div>
  </body>
  <script type="text/javascript">
    var abi, contractAddress, contract, account, acclist;
    var GAS_AMOUNT = 900000;

    function revokeService(servicenum)
    {
        var filepath = $('#fp'+servicenum).html();
        var providerurl = $('#pu'+servicenum).html();
        var rate = $('#rt'+servicenum).html();
        var provider = $('#pa'+servicenum).html();
        contract.revokeServiceByClient(provider, servicenum, {gas: GAS_AMOUNT, from: account});
        $.ajax({
            url: 'revoke',
            method : 'GET',
            data : {
                path : provider,
                servicenum : servicenum
            },
            success: function(data) {
                alert("AGREEMENT REVOKED");
                location.reload();
            }            
        })
    }

    function challenge(servicenum)
    {
        var filepath = $('#fp'+servicenum).html();
        console.log(filepath);
        var providerurl = $('#pu'+servicenum).html();
        var rate = $('#rt'+servicenum).html();
        var provider = $('#pa'+servicenum).html();
        web3.eth.sendTransaction({to:provider, from:account, value:web3.toWei(rate, "ether")})
        console.log("REPAY DONE SUCCESSFULLY");
        $.get('challenge', params = {
                'servicenum' : servicenum,
                'provider': provider,
                'providerurl': providerurl,
                'rate': rate,
                'path': filepath,
            }, function(data, status){
                console.log(data)
                if(data['result']==true) {
                    alert("DATA SUCCESSFULLY VERIFIED");
                }
                else {
                    alert("DATA VERIFICATION FAILED");
                }
                location.reload()
            }
        );
    }
    
    $('#filepathform').click(function(event){
        console.log("SENDING UPLOAD REQUESTR");
        $.ajax({
            url: 'upload',
            method : 'GET',
            data : {
                path : $('#pathinput').val(),
            },
            success: function(data) {
                alert("DATA UPLOADED");
                location.reload()
            }            
        })
    });
    
     function initializeWeb3(contract)
    {
      web3.eth.getAccounts(function(err, accs) {
        wtoE = web3.toWei(1,'ether');
        if(typeof accs !== 'undefined')
        {
          account  = accs[1];
          acclist = accs;
        }
        else
        {
          alert("CANNOT CONNECT TO RPC");
        }
      });
    }
    
    $(document).ready(function() {
    
      if (typeof web3 !== 'undefined') {
        console.warn("Using web3 detected from external source. If you find that your accounts don't appear or you have 0 MetaCoin, ensure you've configured that source properly. If using MetaMask, see the following link. Feel free to delete this warning. :) http://truffleframework.com/tutorials/truffle-and-metamask");
        window.web3 = new Web3(web3.currentProvider);
      } else {
        console.warn("No web3 detected. Falling back to http://localhost:8545. You should remove this fallback when you deploy live, as it's inherently insecure. Consider switching to Metamask for development. More info here: http://truffleframework.com/tutorials/truffle-and-metamask");
        window.web3 = new Web3(new Web3.providers.HttpProvider("http://localhost:8545"));
        console.log("CONNECTED");
      }
    
      console.log("TRYING CONTRACT");
    
      $.ajax({
        method : "GET",
        url : "http://localhost:8900/contract",
        success : function(response) {
          console.log("ON SUCCESS");
          abi = response['abi'];
          contractAddress = response['address'];
          contract = web3.eth.contract(abi).at(contractAddress);
          initializeWeb3(contract);
        }
      });
    });
  </script>
</html>